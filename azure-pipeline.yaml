trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

# ✅ Run inside Google Cloud SDK container
container:
  image: google/cloud-sdk:latest

# ✅ ✅ ✅ LINK VARIABLE GROUP (THIS WAS MISSING)
variables:
- group: mountain-peak-view

- name: PROJECT_ID
  value: e00049-development-project
- name: REGION
  value: us-central1
- name: CLUSTER_NAME
  value: mountain-peak-view
- name: IMAGE_REPO
  value: e00049-development-project/mountain-peak-view/single-page-app

steps:

# ✅ 1️⃣ Checkout Source
- checkout: self
  displayName: "Checkout Source Code"

# ✅ 2️⃣ Authenticate to GCP & GKE (FIXED)
- script: |
    echo "$(GCP_SA_KEY)" | base64 -d > key.json

    echo "✅ Key file created:"
    head -n 2 key.json

    gcloud auth activate-service-account --key-file=key.json
    gcloud config set project $(PROJECT_ID)
    gcloud container clusters get-credentials $(CLUSTER_NAME) --region $(REGION)

    kubectl get nodes
  displayName: "Authenticate to GKE"

# ✅ 3️⃣ Login to Google Artifact Registry
- script: |
    gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
  displayName: "Login to GAR"

# ✅ 4️⃣ Build Docker Image with Dynamic Build Name
- script: |
    IMAGE_URI="us-central1-docker.pkg.dev/$(IMAGE_REPO):$(Build.BuildNumber)"

    docker build -t $IMAGE_URI .
    docker tag $IMAGE_URI us-central1-docker.pkg.dev/$(IMAGE_REPO):latest

    echo "##vso[task.setvariable variable=IMAGE_URI]$IMAGE_URI"
    echo "Built Image: $IMAGE_URI"
  displayName: "Build Docker Image"

# ✅ 5️⃣ Push Image to GAR
- script: |
    docker push us-central1-docker.pkg.dev/$(IMAGE_REPO):$(Build.BuildNumber)
    docker push us-central1-docker.pkg.dev/$(IMAGE_REPO):latest
  displayName: "Push Docker Image to GAR"

# ✅ 6️⃣ Deploy to GKE using GitHub YAML
- script: |
    echo "Deploying Image: $(IMAGE_URI)"

    sed -i "s|IMAGE_PLACEHOLDER|$(IMAGE_URI)|g" deployment/deployment.yaml

    kubectl apply -f deployment/deployment.yaml
    kubectl apply -f deployment/service.yaml

    kubectl rollout status deployment/single-page-app --timeout=180s

    echo "✅ Deployment Completed Successfully"
  displayName: "Deploy to GKE"
